encoding  utf-8
source bat_cave.th
# Change name to the main therion file

#Surveys to output
#-----------------
  export map   -o .\_output\bat_caveE0.pdf -proj [elevation 0] -layout elevation  #side on view across 0 deg plane
  #export model -o .\_output\bat_cave.lox                                          #3d therion model to be viewed in the therion viewer
  export map   -o .\_output\bat_cave.pdf -proj plan -layout plan                  #Produces plan of cave, on a single sheet

  #export model -o .\_output\bat_caveth.3d -fmt survex                            #Survex file showing centre line only
  export map   -o .\_output\bat_cave.kml -fmt kml                                #for Google Earth
  #export map   -o .\_output\bat_cave_Walls.3d -proj plan                         #Survex file showing walls only
  #export map   -o .\_output\bat_caveEe.pdf -proj extended -layout elevation      #side on view across custom extended plane

#inject standard code for layouts
  input ..\..\..\..\CodeLibrary\_translations.txt  # custom translations
  input ..\..\..\..\CodeLibrary\_layouts.mp        # custom Metapost
  input ..\..\..\..\CodeLibrary\_layouts.tex       # custom tex
  input ..\..\..\..\CodeLibrary\_layouts.thc       # custom layouts 

#Text transformations (not in translations.txt file)
  text en "area sump"             "sump / deep water<br>"
  text en "line u:plankwalk"      "path<br>"
  text en "line wall:unsurveyed"  "surface<br>"


layout elevation
  copy LayoutColourSymbols
  scale 1 100
  base-scale 1 100
  symbol-hide group cave-centreline
  opacity 40
  #colour map-bg [70 90 70]
  #Set grid related settings
    grid-size 5 5 5 m
    grid-coords all
    grid bottom
  #turn off items
    map-header 0 0 off
    statistics topo-length off
    statistics topo off
    statistics explo-length off
    legend off  
    debug off

  code metapost  
    inputrel("/_custom.mp")
  endcode
endlayout

layout plan
  copy LayoutColourSymbols
  map-comment "Danjugan Island, Negros<br>\
18° 1'15.52 N<br>\
121°59'53.82 E<br>\
Western Visaya Caving Association<br>\
Bristol Exploration Club, UK<br>\
Danjugan Island Sanctuary<br>\
BCRA Grade 5C<br>\
Data: https://github.com/speleo/SpeleoPhilippines/tree/master/Region-6/Negros/Danjugan_Island/bat_cave<br>\"          
                     
  ### index of file options from _layouts.mp
    #copy custom_water_blue
    #copy custom_entrance_theta
    #copy custom_entrance_theta_large
    #copy custom_scalebar_large_format
    #copy custom_scalebar_medium_format
    copy custom_scalebar
    #copy custom_scalebar_vertical
    #copy custom_legend_large_format
    #copy custom_legend_large_format_5U
    #copy custom_legend_large_format_20U
    #copy custom_grid_2_continuous
    #copy custom_centerline_2_continuous
    #copy custom_bats
    copy custom_north_arrow_150
    #copy custom_north_arrow_300
    #copy custom_north_arrow_600
    #copy custom_northarrow_large
    #copy custom_line_doline

  ### index of file options from _layouts.tex
    #copy custom_colorlegendbox
    #copy custom_legendsymbolbox
    #copy custom_title_area_format
    #copy custom_title_area_format_20
    #copy custom_title_area_format_1000
    #copy custom_logos

  ### index of file options from _layouts.thc
    copy custom_symbols
    #copy custom_color
    #copy custom_large_odessa
    #copy custom_small_odessa
      
  scale 1 100
  base-scale 1 100
  scale-bar 10 m
  debug off
  map-image 106 0 ne .\_output\bat_caveE0.pdf    #inject the side view into the output
    
  #Foreground color - turn on altitdude to see various heights
  #colour map-fg [80 80 80]
  #color map-fg altitude
  #colour map-bg [70 90 70]
  
  language en
  statistics topo-length off
  statistics topo all
  statistics explo-length off
  statistics explo off
    
  transparency on
  opacity 70
  
  legend on
  legend-columns 1
  legend-width 37 cm
  colour-legend on
  
  #Set grid related settings
    #grid-size 5 5 5 m
    grid bottom
    grid-coords off
  #sketches on
  
  doc-author   "Henry Bennett"
  doc-keywords "Bat Cave Danjugan Island Negros Philippines"
  doc-subject  "Survey of Bat Cave 2022"
  doc-title    "Bat Cave Survey Bristol Exploration Club 2022"
            
  code tex-map
    \def\maplayout{
      \legendbox{-17}{170}{NW}{\the\legendcontent}
      %\legendbox{140}{160}{SE}{\size[40] Danjugan Island, Negros}
      \legendbox{106}{0}{NE}{\loadpicture{./_output/bat_caveE0.pdf}}

      \legendbox{40}{163}{NW}{\loadpicture{./images/danjugan-island-logo-black-text.png}}      
      \legendbox{120}{-40}{NW}{\loadpicture{./images/WVCA-logo-300px.jpg}}
      \legendbox{120}{-75}{NW}{\loadpicture{./images/sitckers-type4-shadow-rotated.png}}
     
      \legendbox{116}{85}{NW}{
        \legendwidth 9 cm
        %\legendtextsize={\size[54]}
        \hsize=\legendwidth
        \input th_legend
      }
    }
               
  \legendcontent={%
    \hsize=\legendwidth
    \ifnortharrow\vbox to 0pt{\line{\hfil\northarrow}\vss}\fi
    \edef\tmp{\the\cavename} \ifx\tmp\empty \else
      {\size[66]\the\cavename} \vskip1cm
    \fi
    \ifscalebar\scalebar\vskip1cm\fi
    {\rightskip=0pt plus 3em\parskip=3bp
      \edef\tmp{\the\comment} \ifx\tmp\empty \else
        {\size[14]\the\comment} \par\medskip
      \fi
      \everypar{\hangindent=2em\hangafter=1}
      \edef\tmp{\the\cavelength} \ifx\tmp\empty \else
        {\size[14]\si\the\cavelengthtitle: \ss\the\cavelength\par}
      \fi
      \edef\tmp{\the\cavedepth} \ifx\tmp\empty \else
        {\size[14]\si\the\cavedepthtitle: \ss\the\cavedepth\par}
      \fi
      \edef\tmp{\the\exploteam} \ifx\tmp\empty \else
        {\size[14]\si\the\explotitle:
  \ss\the\exploteam\quad\si\the\explodate\par}
      \fi
  \edef\tmp{\the\topoteam} \ifx\tmp\empty \else
    {\size[14]\si\the\topotitle: \ss\the\topoteam\quad\si\the\topodate\par}
  \fi
  \edef\tmp{\the\cartoteam} \ifx\tmp\empty \else
    {\size[14]\si\the\cartotitle:
  \ss\the\cartoteam\quad\si\the\cartodate\par}
      \fi
      \edef\tmp{\the\copyrights} \ifx\tmp\empty \else
        {\size[14]\ss\the\copyrights\par}
      \fi
    }
    %\formattedlegend
  }
  
  endcode


###################################################################
#
# MM    MM EEEEEEE TTTTTTT   AAA   PPPPPP   OOOOO   SSSSS  TTTTTTT 
# MMM  MMM EE        TTT    AAAAA  PP   PP OO   OO SS        TTT   
# MM MM MM EEEEE     TTT   AA   AA PPPPPP  OO   OO  SSSSS    TTT   
# MM    MM EE        TTT   AAAAAAA PP      OO   OO      SS   TTT   
# MM    MM EEEEEEE   TTT   AA   AA PP       OOOO0   SSSSS    TTT  
#
###################################################################

  code metapost
    inputrel("/_custom.mp")
   
    def l_u_plankwalk  (expr P) = T:=identity;
      cas := 0;
      dlzka := arclength P;
      mojrok := adjust_step(dlzka, 0.5u);
      pickup PenD;
      forever:
        t := arctime cas of P;
        thdraw ((point t of P) + 0.5 * u * unitvector(thdir(P,t) rotated 90)) --
        ((point t of P) - 0.5 * u * unitvector(thdir(P,t) rotated 90) );
        cas := cas + mojrok;
        exitif cas > dlzka + (mojrok/3);  % for rounding errors
      endfor;
      pickup PenC;
      %thdraw P; 
      %draw path withcolor (0.5, 0 ,0)
    enddef;
    
    def l_wall_unsurveyed (expr P) = 
      T:=identity;
      pickup PenC;
      thdraw P dashed evenly scaled (2*optical_zoom);
    enddef;
    
    #change the size of the default fonts
    #fonts_setup(<tinysize>,<smallsize>,<normalsize>,<largesize>,<hugesize>);
    #origional fonts_setup(6,8,10,14,20);
    fonts_setup(6,8,30,54,80);
  
  endcode
endlayout

#CODE TO MAKE FULL COLOUR SYMBOLS
#----------------------------
#experimental layout RBM July 2010
layout LayoutColourSymbols
#affects colour symbol linework but not labels and not fills
  
  symbol-colour point station [54 7 60]  #purple[54 7 60] #seems to affect +s, flag symbols and station text
  
  #survey cave
  symbol-colour group cave-centreline [35 16 16] # brown [35 16 16] # red brown [50 0 0]
  symbol-colour point cave-station [35 16 16]  #ineffective?
  #symbol-colour point station-name [0 100 0]  
  
  #survey surface
  symbol-colour group surface-centreline [54 74 29] # green [54 74 29]
  symbol-colour point surface-station [54 74 29]  #ineffective?
  symbol-colour point flag:entrance [54 74 29]  #ineffective?
  
  #magenta
  symbol-colour group equipment  [80 0 40] # magenta [80 0 40]
  
  #dark blue
  # symbol-colour group water  [22 22 95] # this breaks custom water definitions
  symbol-colour point water-flow  [22 22 95]
  symbol-colour line water-flow  [22 22 95]  
  symbol-colour point water [22 22 95]      # inconsistent?
  symbol-colour area sump [22 22 95]  # this breaks custom water definitions
  #symbol-colour area sump [00bfff]

  #light blue  
   symbol-colour area water [86 100 100]  # this breaks custom water definitions
  
  #define colours for redefined water point & area
  code metapost  
  %these colours affect fills, not the linework
    !color colour_water_bg; %! forces interpretation as metapost
    colour_water_bg := (0.86,1,1);      %light blue
    !color colour_sump_bg;  %! forces interpretation as metapost
    %colour_sump_bg := (.22,.22,.95);    %dark blue
    %colour_sump_bg := (.0,.75,1);    %dark blue
    colour_sump_bg := (.80,1,1);    %dark blue
  
    %these colours affect the linework  
    !color colour_rope;  %! forces interpretation as metapost
    colour_rope :=  (0.35,0.75,1.0);    %blue  
    
  %this colour for redefined entrance symbol (not point station flag entrance)
    !color colour_entrance;  %! forces interpretation as metapost
    colour_entrance :=  (0.54,0.74,0.29);      
    endcode
endlayout LayoutColourSymbols
